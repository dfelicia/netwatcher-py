<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetWatcher - Code Architecture & Flow Guide</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.8em;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.3em;
            font-style: italic;
        }
        .intro {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 40px;
            border-left: 5px solid #3498db;
        }
        .intro h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin: 40px 0;
        }
        .step {
            display: flex;
            align-items: flex-start;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 6px solid #3498db;
            transition: all 0.3s ease;
            position: relative;
        }
        .step:hover {
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .step-number {
            background: #3498db;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3em;
            margin-right: 25px;
            flex-shrink: 0;
        }
        .step-content {
            flex: 1;
        }
        .step-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .step-description {
            font-size: 1.1em;
            color: #34495e;
            margin-bottom: 12px;
        }
        .step-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .code-snippet {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre;
        }
        .file-path {
            background: #e8f5e8;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .arrow {
            text-align: center;
            font-size: 2em;
            color: #3498db;
            margin: 10px 0;
        }
        .three-paths {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        .path {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-top: 4px solid #e74c3c;
            text-align: center;
        }
        .path.main {
            border-top-color: #27ae60;
        }
        .path.test {
            border-top-color: #f39c12;
        }
        .helper-modules {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        .module {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        .complete-flow {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 40px 0;
        }
        .complete-flow h2 {
            color: white;
            margin-top: 0;
        }
        .flow-step {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .benefits {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
        }
        .benefits h2 {
            color: #27ae60;
            margin-top: 0;
        }
        @media (max-width: 768px) {
            .three-paths {
                grid-template-columns: 1fr;
            }
            .helper-modules {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üï∏Ô∏è NetWatcher</h1>
        <div class="subtitle">Code Architecture & Flow Guide</div>

        <div class="intro">
            <h2>üìñ Introduction</h2>
            <p><strong>NetWatcher</strong> is a macOS network automation tool that automatically reconfigures your system settings when your network environment changes. This guide walks through exactly how the code works, step-by-step, perfect for developers who want to understand the architecture.</p>
            <p><strong>Think of it like a recipe:</strong> We'll follow the program from its entry point through every function call, showing you how each piece connects to create the complete automation system.</p>
        </div>

        <h2>üöÄ Step 1: How the Program Starts</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Entry Point: <span class="file-path">src/cli.py</span></div>
                    <div class="step-description">When you type <code>netwatcher</code> in terminal, Python calls the main() function</div>
                    <div class="step-details">
                        <strong>What happens here:</strong><br>
                        1. <strong>Parses commands</strong> - Figures out what you want to do (start, stop, test, etc.)<br>
                        2. <strong>Sets up logging</strong> - Uses centralized NetWatcherLogger with proper initialization order<br>
                        3. <strong>Routes to the right action</strong> - Sends you to the correct part of the program
                        <div class="code-snippet">
def main():
    """Main entry point for the NetWatcher CLI."""
    # This is where everything starts!
    cli()  # Processes command line arguments
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2>üéØ Step 2: The Three Main Paths</h2>
        <p>From the CLI, the program can go down three main paths:</p>

        <div class="three-paths">
            <div class="path main">
                <h3>üçé Path A: Menu Bar App</h3>
                <p><code>netwatcher start</code></p>
                <div class="code-snippet">
# Goes to src/watcher.py
watcher = NetWatcherApp()
watcher.run()
                </div>
                <p><strong>Main use case</strong> - Runs continuously in menu bar</p>
            </div>

            <div class="path test">
                <h3>üß™ Path B: Quick Test</h3>
                <p><code>netwatcher test</code></p>
                <div class="code-snippet">
# Stays in cli.py but calls core logic
check_and_apply_location_settings(
    config, apply=True
)
                </div>
                <p><strong>Testing</strong> - One-time execution</p>
            </div>

            <div class="path">
                <h3>‚öôÔ∏è Path C: Utilities</h3>
                <p><code>netwatcher stop/status</code></p>
                <div class="code-snippet">
# Simple utility functions
service_control_commands()
                </div>
                <p><strong>Management</strong> - Start/stop/status</p>
            </div>
        </div>

        <p><strong>Let's follow Path A (Menu Bar App)</strong> since that's the main use case:</p>

        <h2>üçé Step 3: The Menu Bar App (<span class="file-path">src/watcher.py</span>)</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Creating the Menu Bar Icon</div>
                    <div class="step-description">NetWatcherApp class creates a little icon in your Mac's menu bar</div>
                    <div class="step-details">
                        <strong>Think of this like a security guard</strong> - it sits quietly in the menu bar, watching for network changes.
                        <div class="code-snippet">
class NetWatcherApp(rumps.App):
    def __init__(self):
        super().__init__("NetWatcher")  # Creates menu bar icon
        self.config = config.load_config()  # Reads your settings
        setup_logging(debug=self.config.get("settings", {}).get("debug", False))  # Centralized logging
        self.logger = get_logger(f"{__name__}.{self.__class__.__name__}")  # Per-class logger
        self._setup_network_watcher()  # Starts listening
                        </div>
                        <strong>The Network Watcher Setup:</strong><br>
                        Uses macOS SystemConfiguration framework to monitor network state changes. This tells macOS: "Hey, whenever the network changes (WiFi connects, VPN turns on, etc.), please call my function!"
                    </div>
                </div>
            </div>
        </div>

        <h2>üîî Step 4: When Network Changes</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-title">Network Change Callback</div>
                    <div class="step-description">When your network changes, macOS automatically calls this function</div>
                    <div class="step-details">
                        <div class="code-snippet">
def network_changed(self, store, changed_keys, info):
    """Called by macOS when network configuration changes."""
    # Don't react immediately - wait a bit (debounce)
    self._schedule_evaluation()
                        </div>
                        <strong>Why wait?</strong> Network changes often happen in bursts (like when connecting to WiFi). The program waits a few seconds to let everything settle before reacting.
                    </div>
                </div>
            </div>
        </div>

        <h2>‚è∞ Step 5: The Debounced Evaluation</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="step-title">Main Coordination Function</div>
                    <div class="step-description">After waiting, it calls the main evaluation function</div>
                    <div class="step-details">
                        This function is like the "brain" - it coordinates everything else.
                        <div class="code-snippet">
def evaluate_network_state(self):
    """Main function that figures out what to do."""
    # Step 5a: Clear cache (start fresh)
    clear_network_cache()

    # Step 5b: Call the core logic
    check_and_apply_location_settings(self.config, apply=True)

    # Step 5c: Clear cache again (cleanup)
    clear_network_cache()
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2>üß† Step 6: The Core Logic (<span class="file-path">src/location/settings.py</span>)</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="step-title">Main Decision-Making Function</div>
                    <div class="step-description">check_and_apply_location_settings() - The main 'brain' function</div>
                    <div class="step-details">
                        <strong>Step 6a: Gather Information (Detective Work)</strong>
                        <div class="code-snippet">
# What network interface are we using?
service_name, interface = get_primary_service_interface()

# What WiFi network are we on?
ssid = get_current_ssid()

# What DNS servers are we using?
dns_servers = get_current_dns_servers()

# Are we on VPN?
vpn_active = is_vpn_active()
                        </div>
                        <strong>Step 6b: Figure Out Location</strong><br>
                        Goes to <span class="file-path">src/location/matching.py</span> with rules like:<br>
                        ‚Ä¢ "If VPN is on, you're at 'Office-VPN'"<br>
                        ‚Ä¢ "If WiFi is 'HomeWiFi', you're at 'Home'"
                        <br><br>
                        <strong>Step 6c: Apply Settings</strong><br>
                        Now configure the computer for this location
                    </div>
                </div>
            </div>
        </div>

        <h2>‚öôÔ∏è Step 7: Applying Settings</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">7</div>
                <div class="step-content">
                    <div class="step-title">apply_location_settings Function</div>
                    <div class="step-description">This function actually changes your computer's settings</div>
                    <div class="step-details">
                        <div class="code-snippet">
def apply_location_settings(location_config, service_name, interface_name):
    # Set DNS servers
    if 'dns_servers' in location_config:
        set_dns_servers(dns_servers, service_name)

    # Set proxy settings
    if 'proxy' in location_config:
        set_proxy(proxy_url, service_name)

    # Set default printer
    if 'default_printer' in location_config:
        set_default_printer(printer_name)

    # Set time server
    if 'ntp_server' in location_config:
        set_ntp_server(ntp_server)
                        </div>
                        Each of these calls goes to <span class="file-path">src/network/configuration.py</span> which runs actual system commands.
                    </div>
                </div>
            </div>
        </div>

        <h2>ÔøΩ Step 7b: Shell Proxy Configuration (<span class="file-path">src/network/shell_proxy.py</span>)</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">7b</div>
                <div class="step-content">
                    <div class="step-title">Terminal Application Proxy Setup</div>
                    <div class="step-description">NetWatcher also configures proxy settings for terminal applications like curl, pip, npm, etc.</div>
                    <div class="step-details">
                        <strong>What happens:</strong>
                        <div class="code-snippet">
def update_shell_proxy_configuration(proxy_url):
    # 1. Parse PAC/WPAD files if needed (with direct connection to avoid circular dependency)
    if proxy_url.endswith('.pac'):
        actual_proxy = parse_pac_file_for_generic_url(proxy_url)  # Downloads via ProxyHandler({}) - no proxy used

    # 2. Generate shell environment files (applies to ALL shells, not just interactive)
    write_bash_proxy_env(proxy_config)    # For bash/zsh
    write_csh_proxy_env(proxy_config)     # For tcsh/csh
    write_fish_proxy_env(proxy_config)    # For fish shell

    # Files created:
    # ~/.config/netwatcher/proxy.env.sh    (bash/zsh)
    # ~/.config/netwatcher/proxy.env.csh   (tcsh/csh)
    # ~/.config/netwatcher/proxy.env.fish  (fish)
                        </div>
                        <strong>Key Benefits:</strong>
                        <ul>
                            <li><strong>No slow startup:</strong> Unlike manual scripts that call curl on every shell startup, NetWatcher generates proxy files once when the network changes</li>
                            <li><strong>Multi-shell support:</strong> Works with bash, zsh, tcsh/csh, and fish shells (both interactive and non-interactive)</li>
                            <li><strong>PAC file parsing:</strong> Automatically extracts actual proxy servers from corporate PAC/WPAD files using direct connections</li>
                            <li><strong>Smart cleanup:</strong> Proxy settings are removed when switching to locations without proxies</li>
                            <li><strong>SwiftBar compatible:</strong> Non-interactive shells (like SwiftBar plugins) now receive proxy settings</li>
                            <li><strong>Circular dependency prevention:</strong> PAC downloads bypass existing proxy settings to avoid timeouts</li>
                        </ul>
                        <strong>Environment Variables Set:</strong>
                        <div class="code-snippet">
# Standard proxy variables
export http_proxy="http://proxy.company.com:8080"
export https_proxy="http://proxy.company.com:8080"
export all_proxy="http://proxy.company.com:8080"

# Legacy uppercase versions (compatibility)
export HTTP_PROXY="http://proxy.company.com:8080"
export HTTPS_PROXY="http://proxy.company.com:8080"

# Special case: rsync expects host:port only
export rsync_proxy="proxy.company.com:8080"

# Bypass addresses (including domains from /etc/resolver)
export no_proxy="localhost,127.0.0.1,*.company.com"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2>ÔøΩüîß Step 8: The System Commands (<span class="file-path">src/network/configuration.py</span>)</h2>
        <div class="flow-container">
            <div class="step">
                <div class="step-number">8</div>
                <div class="step-content">
                    <div class="step-title">Where the Rubber Meets the Road</div>
                    <div class="step-description">This literally runs Mac terminal commands to change your network settings!</div>
                    <div class="step-details">
                        <strong>Example: Setting DNS Servers</strong>
                        <div class="code-snippet">
def set_dns_servers(dns_servers, service_name):
    """Actually change the DNS servers on your Mac."""
    # Build command: networksetup -setdnsservers "Wi-Fi" 8.8.8.8 8.8.4.4
    cmd = ["networksetup", "-setdnsservers", service_name] + dns_servers
    run_command(cmd)  # Execute the command
                        </div>
                        This is the actual system integration - changing macOS network configuration through official command-line tools.
                    </div>
                </div>
            </div>
        </div>

        <h2>üöÄ Step 9: Helper Modules</h2>
        <p>The program uses several specialized helper modules:</p>

        <div class="helper-modules">
            <div class="module">
                <h3>üîç Network Detection</h3>
                <p><span class="file-path">src/network/detection.py</span></p>
                <p><strong>What it does:</strong> Figures out your current network state</p>
                <p><strong>Example:</strong> "What WiFi am I connected to?" ‚Üí calls <code>get_current_ssid()</code></p>
            </div>

            <div class="module">
                <h3>üíæ Network Caching</h3>
                <p><span class="file-path">src/network/cache.py</span></p>
                <p><strong>What it does:</strong> Remembers answers to avoid asking the same question twice</p>
                <p><strong>Example:</strong> If we checked "Am I on VPN?" 5 seconds ago, use that answer</p>
            </div>

            <div class="module">
                <h3>‚öôÔ∏è Configuration</h3>
                <p><span class="file-path">src/config.py</span></p>
                <p><strong>What it does:</strong> Reads your settings from config file</p>
                <p><strong>Example:</strong> Knows "Home" location should use DNS server "192.168.1.1"</p>
            </div>

            <div class="module">
                <h3>üîå External Tools</h3>
                <p><span class="file-path">src/external/</span></p>
                <p><strong>What it does:</strong> Talks to other programs (like Cisco VPN client)</p>
                <p><strong>Example:</strong> Asks VPN software "Are you connected?"</p>
            </div>
        </div>

        <div style="background: #f0f8ff; padding: 25px; border-radius: 10px; margin: 30px 0; border-left: 5px solid #4a90e2;">
            <h2>üîÑ Recent Architecture Improvements</h2>
            <p><strong>NetWatcher has been modernized with several key improvements:</strong></p>
            <ul>
                <li><strong>Removed Compatibility Layer:</strong> Eliminated <code>src/actions.py</code> wrapper - modules now import directly from specialized modules</li>
                <li><strong>Fixed Background Service Logging:</strong> Proper logger initialization ensures both CLI and background service log correctly</li>
                <li><strong>PAC Download Improvements:</strong> PAC/WPAD files now download via direct connections (no proxy) to prevent circular dependencies</li>
                <li><strong>Enhanced Shell Support:</strong> Shell proxy settings now apply to all shells (interactive and non-interactive) for better SwiftBar/script compatibility</li>
                <li><strong>Simplified Code Quality:</strong> Applied ruff formatting and complexity reduction - cleaner, more maintainable code</li>
            </ul>
            <p><em>These changes assume fresh installs and eliminate legacy compatibility code, making NetWatcher cleaner and more reliable.</em></p>
        </div>

        <div class="complete-flow">
            <h2>üîÑ The Complete Flow</h2>
            <p>Here's the complete journey from start to finish:</p>

            <div class="flow-step">
                <strong>1. You connect to WiFi</strong> ‚Üí macOS notices the network change
            </div>
            <div class="flow-step">
                <strong>2. macOS tells NetWatcher</strong> ‚Üí <code>network_changed()</code> function is called
            </div>
            <div class="flow-step">
                <strong>3. NetWatcher waits</strong> ‚Üí Debounce timer (5 seconds) to let things settle
            </div>
            <div class="flow-step">
                <strong>4. NetWatcher investigates</strong> ‚Üí "What network am I on? VPN? DNS servers?"
            </div>
            <div class="flow-step">
                <strong>5. NetWatcher decides</strong> ‚Üí "This looks like 'Home' location"
            </div>
            <div class="flow-step">
                <strong>6. NetWatcher configures</strong> ‚Üí Changes DNS, proxy, printer, time server
            </div>
            <div class="flow-step">
                <strong>7. NetWatcher reports</strong> ‚Üí Logs what it did, updates menu bar
            </div>
            <div class="flow-step">
                <strong>8. NetWatcher waits</strong> ‚Üí Ready for the next network change
            </div>
        </div>

        <h2>üéõÔ∏è Configuration File Example</h2>
        <div class="step-details">
            All the rules are stored in <span class="file-path">~/.config/netwatcher/config.toml</span>:
            <div class="code-snippet">
[locations.work]
ssids = ["YourWorkSSID"]
dns_search_domains = ["corp.example.com"]
dns_servers = ["10.1.1.10", "10.1.1.11"]  # Corporate DNS servers
proxy_url = "http://proxy.example.com:8080/proxy.pac"
printer = "Work_Printer_Name"
ntp_server = "time.corp.example.com"

[locations.home]
ssids = ["YourHomeSSID"]
dns_search_domains = ["home.arpa"]
dns_servers = []  # Use DHCP-provided DNS servers
proxy_url = ""
printer = "Home_Printer_Name"
ntp_server = "time.apple.com"
            </div>
            This tells NetWatcher: "When you see this situation, apply these settings."
        </div>

        <div class="benefits">
            <h2>üí° Key Python Concepts Used</h2>
            <p>Even though this is complex, it uses pretty basic Python concepts:</p>
            <ul>
                <li><strong>Functions</strong> - Small pieces that do one job</li>
                <li><strong>Classes</strong> - <code>NetWatcherApp</code> bundles related functions together</li>
                <li><strong>Imports</strong> - Direct imports from specialized modules (no compatibility layer)</li>
                <li><strong>Dictionaries</strong> - Configuration stored as <code>{"dns_servers": ["8.8.8.8"]}</code></li>
                <li><strong>Decorators</strong> - <code>@cache_network_function</code> automatically adds caching to functions</li>
                <li><strong>HTTP Handlers</strong> - <code>ProxyHandler({})</code> for direct PAC downloads without proxy circular dependencies</li>
            </ul>
            <p><strong>The complexity comes from coordination</strong> - making sure all these pieces work together smoothly, not from advanced Python features.</p>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 25px; background: #e8f5e8; border-radius: 10px;">
            <h3 style="color: #27ae60; margin-top: 0;">üéâ Result</h3>
            <p style="font-size: 1.2em; margin-bottom: 0;">
                Your Mac automatically adapts to every network environment - home, office, coffee shop -
                through this elegant orchestration of Python modules, macOS system calls, and intelligent decision-making logic.
                <br><br>
                <strong>Recent improvements ensure reliable PAC downloads, consistent logging, and enhanced shell compatibility.</strong>
            </p>
        </div>
    </div>
</body>
</html>
